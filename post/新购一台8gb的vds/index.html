<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><link rel=icon type=image/ico href=https://blog.yzyy.de/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.yzyy.de/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.yzyy.de/favicon-32x32.png><link rel=icon type=image/png sizes=192x192 href=https://blog.yzyy.de/android-chrome-192x192.png><link rel=apple-touch-icon sizes=180x180 href=https://blog.yzyy.de/apple-touch-icon.png><meta name=description content="因云服务器商「ClawCloud」调整中国优化线路，获得了内存翻倍的新加坡/日本8GB VDS。本文详细记录了新购服务器后的安全配置、Docker与服务环境搭建、Cloudflare API下acme.sh自动续签SSL证书的简化流程，以及OpenWebUI等服务的数据迁移实操与遇到的问题，旨在为服务器搬家和运维提供实用参考。"><title>新购一台8GB的VDS与搬家 | G-Hung的博客</title><link rel=canonical href=https://blog.yzyy.de/post/%E6%96%B0%E8%B4%AD%E4%B8%80%E5%8F%B08gb%E7%9A%84vds/><meta property="og:url" content="https://blog.yzyy.de/post/%E6%96%B0%E8%B4%AD%E4%B8%80%E5%8F%B08gb%E7%9A%84vds/"><meta property="og:site_name" content="G-Hung的博客"><meta property="og:title" content="新购一台8GB的VDS与搬家"><meta property="og:description" content="因云服务器商「ClawCloud」调整中国优化线路，获得了内存翻倍的新加坡/日本8GB VDS。本文详细记录了新购服务器后的安全配置、Docker与服务环境搭建、Cloudflare API下acme.sh自动续签SSL证书的简化流程，以及OpenWebUI等服务的数据迁移实操与遇到的问题，旨在为服务器搬家和运维提供实用参考。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2025-07-17T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-17T00:00:00+00:00"><meta property="article:tag" content="生活"><meta property="article:tag" content="服务器"><link rel=stylesheet href=/assets/combined.min.b72766531fc58b8c9eb741223d816b1c10ab962791e1d50d5f6fcb81345cde80.css media=all><script async src="https://www.googletagmanager.com/gtag/js?id=G-88BLW4V0HZ"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-88BLW4V0HZ")}</script></head><body class=auto><div class=content><header><div class=header><h1 class=header-title><a href=https://blog.yzyy.de/>G-Hung的博客</a></h1><div class=header-menu><p class=small><a href=/>/home</a></p><p class=small><a href=/post>/日常</a></p><p class=small><a href=/explore>/探索记录</a></p><p class=small><a href=/tags>/tags</a></p><a href=/index.xml target=_blank title=RSS class=rss-icon><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div></div></header><main class=main><div class=breadcrumbs><a href=/>Home</a><span class=breadcrumbs-separator>/</span><a href=/post/>Posts</a><span class=breadcrumbs-separator>/</span>
<a href=/post/%E6%96%B0%E8%B4%AD%E4%B8%80%E5%8F%B08gb%E7%9A%84vds/>新购一台8GB的VDS与搬家</a></div><div class=autonumber><article><header class=single-intro-container><h1 class=single-title>新购一台8GB的VDS与搬家</h1><p class=single-summary>记录一次新购VDS并迁移服务的全过程，包括数据迁移与踩坑心得。</p><div class=single-subsummary><img src=/avatar.jpg alt="Author Avatar"><div><p class=author>ghung</p><p class=single-date><time datetime=2025-07-17T00:00:00+00:00>2025 Jul 17</time>
&nbsp; · &nbsp;7 min read</p></div></div></header><div class=single-tags><span><a href=https://blog.yzyy.de/tags/%E7%94%9F%E6%B4%BB/>#生活</a>
</span><span><a href=https://blog.yzyy.de/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/>#服务器</a></span></div><aside class=toc><p><strong>Table of contents</strong></p><nav id=TableOfContents><ul><li><a href=#安全>安全</a></li><li><a href=#安装docker>安装docker</a></li><li><a href=#ssl证书>SSL证书</a><ul><li><a href=#自动续签改进后的方案>自动续签改进后的方案</a></li></ul></li><li><a href=#迁移服务>迁移服务</a><ul><li><a href=#openwebui--newapi>OpenWebUI + NewAPI</a></li><li><a href=#openlist>OpenList</a></li><li><a href=#sub-store>sub-store</a></li><li><a href=#gemini-balance>Gemini-balance</a></li><li><a href=#pdfmathtranslate>PDFMathTranslate</a></li></ul></li><li><a href=#安装新服务>安装新服务</a><ul><li><a href=#1panel>1Panel</a></li><li><a href=#哪吒监控v1>哪吒监控V1</a></li></ul></li><li><a href=#关闭-ipv6--开启bbr>关闭 ipv6 & 开启bbr</a></li></ul></nav></aside><div class=single-content><p>在7月8日，人称“小阿里”的云服务器提供商「ClawCloud」宣布下线支持中国优化线路的香港服务器。这个公告中还提到了三个赔偿方案，其中两个为不同的退款方案，这里重点关注方案二：可以免费迁移到新加坡或日本节点，并且**原本机器的内存容量还会直接翻倍。</p><p>这就导致了市场上出现了2核8GB的线路良好的新加坡\日本机器，并且价格为4$/m，有没有很心动，我反正是心动了。</p><p>回想起那夜远程开发使用claude code内存爆炸，狼狈重启。那夜为了安装OpenWebUI，一口气开了2g的swap。畏畏缩缩不敢使用动态博客、不敢使用1panel等运维面板。怕了真怕了，😭狼狈的我含泪溢价一百块收下一台机器，只希望能用的长久吧。</p><p>以下记录一下我拿到一台新机器会做什么以及迁移过程。</p><hr><h2 class=heading id=安全>安全
<a class=anchor href=#%e5%ae%89%e5%85%a8>#</a></h2><p>最重要的当然是安全，之前已经给出了服务器的安全论，请看<a href=/explore/%E6%9C%8D%E5%8A%A1%E5%99%A8/vps%E5%9F%BA%E6%9C%AC%E5%AE%89%E5%85%A8%E6%8E%AA%E6%96%BD/>VPS基础安全配置实践指南</a>。</p><h2 class=heading id=安装docker>安装docker
<a class=anchor href=#%e5%ae%89%e8%a3%85docker>#</a></h2><p>因为多数服务是运行在docker上的，安装docker & docker compose是必不可少的。</p><h2 class=heading id=ssl证书>SSL证书
<a class=anchor href=#ssl%e8%af%81%e4%b9%a6>#</a></h2><p>不是简单地迁移已有证书就行了，还要迁移配置好的自动续签服务，经过查看在一台机器上有四个域名的自动续签服务，但是我准备瘦身一下，有些域名快到期了。<figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/certificates.png></div></figure></p><h3 class=heading id=自动续签改进后的方案>自动续签改进后的方案
<a class=anchor href=#%e8%87%aa%e5%8a%a8%e7%bb%ad%e7%ad%be%e6%94%b9%e8%bf%9b%e5%90%8e%e7%9a%84%e6%96%b9%e6%a1%88>#</a></h3><p>发现之前的多个域名的自动续签管理十分繁琐，与AI交流后获得了一个更为简洁的可行的方案，简化了操作与配置。</p><h4 class=heading id=cloudflare-api>Cloudflare API
<a class=anchor href=#cloudflare-api>#</a></h4><p>使用 Cloudflare DNS 模式需要准备:</p><ul><li>Account ID</li><li>API Token</li></ul><h5 class=heading id=获取-account-id>获取 Account ID
<a class=anchor href=#%e8%8e%b7%e5%8f%96-account-id>#</a></h5><p>这两种 ID 直接在 Overview 页就能找到。</p><p><figure><div class=img-container><img loading=lazy alt=cloudflare_account_id src=https://webp.050612.xyz/2025/07/cloudflare_account_id.png></div></figure></p><h5 class=heading id=获取-api-token>获取 API Token
<a class=anchor href=#%e8%8e%b7%e5%8f%96-api-token>#</a></h5><p>Overview 页点击 <code>获取您的 API 令牌</code> 进入 API Tokens 页。</p><p>点击 API Tokens 项旁边 <code>创建令牌</code> 按钮，接着选择 <code>编辑区域 DNS</code> 的模板，点击 <code>使用模板</code>。</p><p><figure><div class=img-container><img loading=lazy alt=image src=https://webp.050612.xyz/2025/02/e15d8a0a1de821faab5355e610b581016975b974_2_690x265.png></div></figure></p><p><figure><div class=img-container><img loading=lazy alt=image src=https://webp.050612.xyz/2025/02/42f87595d27a6fb3ed1fe329934517f5416920c6_2_690x210.png></div></figure></p><p><code>区域资源</code> 里选择需要签发的域名，多个域名选择多个。不建议选择全部的域名，**最小权限原则。</p><p>在 <code>客户端 IP 地址筛选</code> 里建议写下 acme.sh 所在的主机做为白名单，需要注意，如果服务器有 ipv6 地址，则也需要添加，因为有可能会 ipv6 优先访问。</p><p>击 <code>继续以显示摘要</code> , 确认没问题后最后点击 <code>创建令牌</code>。</p><p><figure><div class=img-container><img loading=lazy alt=image src=https://webp.050612.xyz/2025/02/e88966d6049c27c31c632f9471ec1b79be287b59_2_510x499.png></div></figure></p><p>此时就会出现一个 Token,，即 CF_Token，拷贝备用。</p><p><figure><div class=img-container><img loading=lazy alt=image src=https://webp.050612.xyz/2025/02/ca6093ea6bf83325809ea6179d4239ae2c9818cc_2_690x404.png></div></figure></p><h5 class=heading id=注意>注意
<a class=anchor href=#%e6%b3%a8%e6%84%8f>#</a></h5><ul><li><strong>注意新增域名时，需要更改API Token所包含的域名</strong></li><li><strong>注意有多台机器时，需要新增机器的IP到白名单</strong>。</li></ul><p><figure><div class=img-container><img loading=lazy alt=update_cf_api_token src=https://webp.050612.xyz/2025/02/update_cf_api_token.png></div></figure><figure><div class=img-container><img loading=lazy alt=cf-api-token-ip src=https://webp.050612.xyz/2025/02/cf-api-token-ip.png></div></figure></p><h4 class=heading id=一个完整的演示>一个完整的演示
<a class=anchor href=#%e4%b8%80%e4%b8%aa%e5%ae%8c%e6%95%b4%e7%9a%84%e6%bc%94%e7%a4%ba>#</a></h4><p>获取到了以上两个token即可开始操作。</p><p>为了使整个流程更加清晰（<del>方便自己操作</del>），这里贴一个自己平时使用 acme.sh 申请证书的完整流程。</p><ul><li>申请方式：DNS 认证（使用 Cloudflare API）</li><li>申请证书 CA：Let’s Encrypt</li><li>申请证书类型：RSA + ECC 两个通配符证书</li></ul><p>后续申请证书的命令，都是在 root 用户下执行的，请先使用 <code>su</code> 切换到 root 用户。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#888;font-style:italic># 进入root用户</span>
</span></span><span style=display:flex><span>su
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 安装 acme.sh</span>
</span></span><span style=display:flex><span>curl  https://get.acme.sh | sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 刷新 shell 变量配置</span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>source</span> ~/.bashrc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 导入 Cloudflare API Token</span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>export</span> <span style=color:#666;font-weight:700;font-style:italic>CF_Token</span>=<span style=color:#666;font-style:italic>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>export</span> <span style=color:#666;font-weight:700;font-style:italic>CF_Account_ID</span>=<span style=color:#666;font-style:italic>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 设置默认 CA 为 Let&#39;s Encrypt</span>
</span></span><span style=display:flex><span>acme.sh --set-default-ca --server letsencrypt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 签发 RSA 证书</span>
</span></span><span style=display:flex><span>acme.sh --issue --dns dns_cf -d xxx.xyz -d *.xxx.xyz --keylength 2048
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 安装 RSA 证书到指定路径</span>
</span></span><span style=display:flex><span>acme.sh --install-cert -d domain.tld <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--key-file       /path/to/ssl/domain.tld_private.key  <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--fullchain-file /path/to/ssl/domain.tld_chain.pem <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--reloadcmd      <span style=color:#666;font-style:italic>&#34;service nginx reload&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 签发 ECC 证书，若不需要，跳过即可</span>
</span></span><span style=display:flex><span>acme.sh --issue --dns dns_cf -d domain.tld -d *.domain.tld --keylength ec-256
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 安装 ECC 证书到指定路径</span>
</span></span><span style=display:flex><span>acme.sh --install-cert -d domain.tld --ecc <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--key-file       /path/to/ssl/ecc_domain.tld_private.key  <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--fullchain-file /path/to/ssl/ecc_domain.tld_chain.pem <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--capath         /path/to/ssl/ecc_domain.tld_ca.pem  <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--reloadcmd      <span style=color:#666;font-style:italic>&#34;service nginx reload&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 至此证书安装完毕</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 下面是同一台主机申请第二个域名证书</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic>###############################第二个域名#####################################################################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 签发 RSA 证书</span>
</span></span><span style=display:flex><span>acme.sh --issue --dns dns_cf -d xxx.xyz -d *.xxx.xyz --keylength 2048
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 安装 RSA 证书到指定路径</span>
</span></span><span style=display:flex><span>acme.sh --config-home /root/.acme2 <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--install-cert -d domain.tld <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--key-file       /path/to/ssl/domain.tld_private.key  <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--fullchain-file /path/to/ssl/domain.tld_chain.pem <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--reloadcmd      <span style=color:#666;font-style:italic>&#34;service nginx reload&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 签发 ECC 证书，若不需要，跳过即可</span>
</span></span><span style=display:flex><span>acme.sh --config-home /root/.acme2 --issue --dns dns_cf -d domain.tld -d *.domain.tld --keylength ec-256
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 安装 ECC 证书到指定路径</span>
</span></span><span style=display:flex><span>acme.sh --config-home /root/.acme2 <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--install-cert -d domain.tld --ecc <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--key-file       /path/to/ssl/ecc_domain.tld_private.key  <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--fullchain-file /path/to/ssl/ecc_domain.tld_chain.pem <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--capath         /path/to/ssl/ecc_domain.tld_ca.pem  <span style=color:#666;font-style:italic>\
</span></span></span><span style=display:flex><span><span style=color:#666;font-style:italic></span>--reloadcmd      <span style=color:#666;font-style:italic>&#34;service nginx reload&#34;</span>
</span></span></code></pre></div><p>检查cron定时任务是否已经成功创建</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -l
</span></span></code></pre></div><p>如果有两个以上的域名或者新增域名，
只需要：</p><ol><li>在Cloudflare的「API Token」管理中，新增API Token所包含的域名</li><li>签发新域名的证书并安装到指定位置</li></ol><p>acme.sh会检查所管理的所有域名的证书的到期时间，如果需要续签，则会执行续签操作并安装导致订位置，实现证书的自动续签。一劳永逸的操作。</p><h2 class=heading id=迁移服务>迁移服务
<a class=anchor href=#%e8%bf%81%e7%a7%bb%e6%9c%8d%e5%8a%a1>#</a></h2><p>到了最复杂的一个环节了，即使运行在docker的服务，每个也要迁移volumes、nginx配置，开干！💪正好凑这个机会统计一下我运行了哪些服务。</p><h3 class=heading id=openwebui--newapi>OpenWebUI + NewAPI
<a class=anchor href=#openwebui--newapi>#</a></h3><ol><li>打包持久化数据，其中NewAPI的MySQL使用了Docker的命名卷</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#888;font-style:italic>######## 打包OpenWebUI和NewAPI的持久化数据</span>
</span></span><span style=display:flex><span>tar -czvf data.tar.gz ./openwebui ./newapi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic>######## 打包newapi MySQL数据卷 ###########</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 查找卷的物理路径</span>
</span></span><span style=display:flex><span>docker volume inspect [项目名]_mysql_data
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 在输出中找到 &#34;Mountpoint&#34;: &#34;/var/lib/docker/volumes/[项目名]_mysql_data/_data&#34;</span>
</span></span><span style=display:flex><span>sudo tar -czvf ~/mysql_volume.tar.gz /var/lib/docker/volumes/[项目名]_mysql_data/_data
</span></span></code></pre></div><ol start=2><li>使用SFTP功能传输到新机器</li><li>在新机器上解压</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-BASH data-lang=BASH><span style=display:flex><span><span style=color:#888;font-style:italic>######## 解压OpenWebUI和NewAPI的持久化数据</span>
</span></span><span style=display:flex><span>sudo tar -xzvf data.tar.gz -C ./
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic>######## 解压newapi MySQL数据卷 ###########</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 手动创建目录</span>
</span></span><span style=display:flex><span>sudo mkdir -p /var/lib/docker/volumes/[项目名]_mysql_data/_data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 解压文件</span>
</span></span><span style=display:flex><span>sudo tar -xzvf ~/mysql_volume.tar.gz -C /var/lib/docker/volumes/[项目名]_mysql_data/_data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 修复文件权限</span>
</span></span><span style=display:flex><span>sudo chown -R 999:999 /var/lib/docker/volumes/[项目名]_mysql_data/_data
</span></span></code></pre></div><ol start=4><li>配置nginx</li></ol><p>直接把旧机器上的nginx打包上传到新机上，操作只需要建立site-available与site-enable的软连接</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ln -s /etc/nginx/sites-available/api.vtofun.me /etc/nginx/sites-enabled/api.vtofun.me
</span></span></code></pre></div><blockquote><p>绷不住了，第一次搬家十分乃至万分不顺利，从七点搬到十一点半还没搬完。搬家太累了😭</p></blockquote><h3 class=heading id=openlist>OpenList
<a class=anchor href=#openlist>#</a></h3><p>想到前段时间的alist的暴雷商业化，我还是把镜像换成OpenList吧。</p><ol><li>docker镜像变更</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>version: <span style=color:#666;font-style:italic>&#39;3.3&#39;</span>
</span></span><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  alist:
</span></span><span style=display:flex><span>    image: <span style=color:#666;font-style:italic>&#39;openlistteam/openlist:latest&#39;</span>
</span></span><span style=display:flex><span>    container_name: alist
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - <span style=color:#666;font-style:italic>&#39;./data:/opt/alist/data&#39;</span>
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#666;font-style:italic>&#39;127.0.0.1:1259:5244&#39;</span>
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      - PUID=0
</span></span><span style=display:flex><span>      - PGID=0
</span></span><span style=display:flex><span>      - UMASK=022
</span></span><span style=display:flex><span>    restart: unless-stopped
</span></span></code></pre></div><ol start=2><li>配置nginx</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ln -s /etc/nginx/sites-available/api.vtofun.me /etc/nginx/sites-enabled/api.vtofun.me
</span></span></code></pre></div><ol start=3><li>注意打开admin用户的webdav的读权限。</li></ol><h3 class=heading id=sub-store>sub-store
<a class=anchor href=#sub-store>#</a></h3><p>很好用的代理配置管理软件</p><ol><li>nginx</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ln -s /etc/nginx/sites-available/substore /etc/nginx/sites-enabled/substore
</span></span><span style=display:flex><span>sudo systemctl restart nginx.service 
</span></span></code></pre></div><h3 class=heading id=gemini-balance>Gemini-balance
<a class=anchor href=#gemini-balance>#</a></h3><p>一个很好用的gemini代理服务，支持多KEY，失败重试等。</p><p>由于之前服务器为香港，而AI服务一般都不支持中国大陆以及香港，所以之前gemini-balance服务部署在一个小机器上。正好趁着这次搬家搬到一起。</p><ul><li>docker-compose.yml文件，通过.env使用和New-API同一个MySQL，避免起两个MySQL服务，造成资源浪费。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>  <span style=color:#888;font-style:italic># Gemini代理池</span>
</span></span><span style=display:flex><span>  gemini-balance:
</span></span><span style=display:flex><span>    image: ghcr.io/snailyp/gemini-balance:latest
</span></span><span style=display:flex><span>    container_name: gemini-balance
</span></span><span style=display:flex><span>    restart: unless-stopped
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#666;font-style:italic>&#34;127.0.0.1:1260:8000&#34;</span> 
</span></span><span style=display:flex><span>    env_file:
</span></span><span style=display:flex><span>      - .env <span style=color:#888;font-style:italic># 同样使用 .env 文件管理配置</span>
</span></span><span style=display:flex><span>    networks:
</span></span><span style=display:flex><span>      - app_network <span style=color:#888;font-style:italic># 加入统一网络</span>
</span></span><span style=display:flex><span>    depends_on:
</span></span><span style=display:flex><span>      mysql:
</span></span><span style=display:flex><span>        condition: service_healthy <span style=color:#888;font-style:italic># 依赖于我们统一的 mysql 服务</span>
</span></span><span style=display:flex><span>    healthcheck:
</span></span><span style=display:flex><span>      test: [<span style=color:#666;font-style:italic>&#34;CMD-SHELL&#34;</span>, <span style=color:#666;font-style:italic>&#34;python -c \&#34;import requests; exit(0) if requests.get(&#39;http://localhost:8000/health&#39;).status_code == 200 else exit(1)\&#34;&#34;</span>]
</span></span><span style=display:flex><span>      interval: 30s
</span></span><span style=display:flex><span>      timeout: 5s
</span></span><span style=display:flex><span>      retries: 3
</span></span><span style=display:flex><span>      start_period: 10s
</span></span></code></pre></div><p>nginx配置文件没有什么特殊的，反代一下即可。</p><h3 class=heading id=pdfmathtranslate>PDFMathTranslate
<a class=anchor href=#pdfmathtranslate>#</a></h3><p>一个基于 AI 完整保留排版的 PDF 文档全文双语翻译，支持 Google/DeepL/Ollama/OpenAI 等服务。</p><h2 class=heading id=安装新服务>安装新服务
<a class=anchor href=#%e5%ae%89%e8%a3%85%e6%96%b0%e6%9c%8d%e5%8a%a1>#</a></h2><h3 class=heading id=1panel>1Panel
<a class=anchor href=#1panel>#</a></h3><p>一键安装的命令：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bash -c <span style=color:#666;font-style:italic>&#34;</span><span style=font-weight:700;text-decoration:underline>$(</span>curl -sSL https://resource.fit2cloud.com/1panel/package/v2/quick_start.sh<span style=font-weight:700;text-decoration:underline>)</span><span style=color:#666;font-style:italic>&#34;</span>
</span></span></code></pre></div><p><figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/20250718151202885.png></div></figure></p><blockquote><p>2025-07-18日更新
1panel 面板bug好多，使用nginx反代面板本身实现https访问，一直卡在loading。不知是不是我操作有问题。</p></blockquote><p>似乎遇见问题的情况有很多。<figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/20250718161106071.png></div></figure></p><h4 class=heading id=问题定位>问题定位
<a class=anchor href=#%e9%97%ae%e9%a2%98%e5%ae%9a%e4%bd%8d>#</a></h4><p>目前使用ip:port方式可以正常访问，使用域名无法访问，可以初步判断为nginx反代的配置问题。</p><h4 class=heading id=问题解决>问题解决
<a class=anchor href=#%e9%97%ae%e9%a2%98%e8%a7%a3%e5%86%b3>#</a></h4><p>贴上一份可以正常工作的nginx配置：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>server</span> {
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>listen</span> 80;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>server_name</span> <span style=color:#666;font-style:italic>xxx</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>return</span> 301 <span style=color:#666;font-style:italic>https://</span><span style=color:#666;font-weight:700;font-style:italic>$server_name$request_uri</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>server</span> {
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>listen</span> 443 <span style=color:#666;font-style:italic>ssl</span> <span style=color:#666;font-style:italic>http2</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>server_name</span>          <span style=color:#666;font-style:italic>xxx</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_certificate</span>      <span style=color:#666;font-style:italic>/etc/ssl/certs/xxx</span>;  
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_certificate_key</span>  <span style=color:#666;font-style:italic>/etc/ssl/private/xxx</span>; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_session_timeout</span> <span style=color:#666;font-style:italic>1d</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_session_cache</span> <span style=color:#666;font-style:italic>shared:MozSSL:10m</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_ciphers</span> <span style=color:#666;font-style:italic>ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_prefer_server_ciphers</span> <span style=color:#666;font-weight:700;font-style:italic>off</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_protocols</span> <span style=color:#666;font-style:italic>TLSv1.1</span> <span style=color:#666;font-style:italic>TLSv1.2</span> <span style=color:#666;font-style:italic>TLSv1.3</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>add_header</span> <span style=color:#666;font-style:italic>Strict-Transport-Security</span> <span style=color:#666;font-style:italic>&#34;max-age=63072000&#34;</span> <span style=color:#666;font-style:italic>always</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>client_max_body_size</span> 500m;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>location</span> <span style=color:#666;font-style:italic>/</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_pass</span> <span style=color:#666;font-style:italic>http://xxxx:1255</span>; <span style=color:#888;font-style:italic># xxx替换为内部访问地址
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_http_version</span> 1<span style=color:#666;font-style:italic>.1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># WebSocket 代理所需的头，1Panel 可能用到
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Upgrade</span> <span style=color:#666;font-weight:700;font-style:italic>$http_upgrade</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Connection</span> <span style=color:#666;font-style:italic>&#34;upgrade&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 重要的转发头
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Host</span> <span style=color:#666;font-weight:700;font-style:italic>$host</span>; <span style=color:#888;font-style:italic># 传递原始请求的 Host 头
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>X-Real-IP</span> <span style=color:#666;font-weight:700;font-style:italic>$remote_addr</span>; <span style=color:#888;font-style:italic># 传递真实客户端IP
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>X-Forwarded-For</span> <span style=color:#666;font-weight:700;font-style:italic>$proxy_add_x_forwarded_for</span>; <span style=color:#888;font-style:italic># 传递完整的IP链
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># *** 传递原始请求协议，解决混合内容问题 ***
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>X-Forwarded-Proto</span> <span style=color:#666;font-weight:700;font-style:italic>$scheme</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 推荐：如果遇到大文件上传或下载问题，可以尝试关闭 buffering
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic># proxy_buffering off;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=color:#888;font-style:italic># proxy_request_buffering off;
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 class=heading id=后记>后记
<a class=anchor href=#%e5%90%8e%e8%ae%b0>#</a></h4><p>在安装1panel之前没有使用过其他运维面板，也不是专业的运维人员，不过有一个GUI总归是好事。可是装上了之后，发现能用上的功能寥寥无几。</p><p>来看看1panel官网介绍：</p><blockquote><p>1Panel 作为一款现代化、开源的 Linux 服务器运维管理面板，其功能涵盖了服务器管理的方方面面，并特别强调了易用性和对新技术的支持。</p></blockquote><h5 class=heading id=核心服务器管理-高效管理>核心服务器管理 (高效管理)
<a class=anchor href=#%e6%a0%b8%e5%bf%83%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ae%a1%e7%90%86-%e9%ab%98%e6%95%88%e7%ae%a1%e7%90%86>#</a></h5><blockquote><p>这个还是很有用的，可以直观看到服务器的资源使用情况。</p></blockquote><ul><li><strong>主机监控</strong>: 实时监控服务器的 CPU、内存、磁盘 I/O、网络等各项性能指标。</li><li><strong>文件管理</strong>: 提供在线文件管理器，方便用户上传、下载、编辑、删除服务器上的文件。</li><li><strong>数据库管理</strong>: 可视化管理 MySQL、PostgreSQL、MongoDB 等多种数据库，包括创建、删除数据库、用户管理等。</li><li><strong>容器管理</strong>: 统一管理 Docker 容器，包括容器的启动、停止、重启、删除、日志查看等。</li></ul><h5 class=heading id=网站与域名管理-快速建站>网站与域名管理 (快速建站)
<a class=anchor href=#%e7%bd%91%e7%ab%99%e4%b8%8e%e5%9f%9f%e5%90%8d%e7%ae%a1%e7%90%86-%e5%bf%ab%e9%80%9f%e5%bb%ba%e7%ab%99>#</a></h5><blockquote><p>对我来说无用，目前docker的基本操作已经够简单了，Nginx配置写起来也不困难。</p></blockquote><ul><li><strong>一键建站部署</strong>: 深度集成 WordPress、Halo 等开源建站软件，支持一键快速部署。</li><li><strong>域名管理与配置</strong>: 方便地进行域名绑定、解析设置。</li><li><strong>SSL 证书管理</strong>: 支持自动申请和配置 Let&rsquo;s Encrypt 等 SSL 证书，实现 HTTPS 安全访问。</li><li><strong>多站点管理</strong>: 支持在同一服务器上管理多个网站。</li></ul><h5 class=heading id=应用生态与商店>应用生态与商店
<a class=anchor href=#%e5%ba%94%e7%94%a8%e7%94%9f%e6%80%81%e4%b8%8e%e5%95%86%e5%ba%97>#</a></h5><blockquote><p>同上，安装应用也不困难。</p></blockquote><ul><li><strong>精选开源应用</strong>: 提供一个丰富的应用商店，涵盖各类高质量的开源工具和应用软件。</li><li><strong>一键安装部署</strong>: 用户可以轻松通过点击安装和部署这些应用。</li><li><strong>自动更新管理</strong>: 支持已安装应用的自动更新。</li><li><strong>数据备份与恢复</strong>: 提供应用数据的一键备份和恢复功能。<ul><li><strong>应用商店中包含的常见应用类别示例</strong>:<ul><li><strong>Web 服务器</strong>: OpenResty, Nginx Proxy Manager, OpenLiteSpeed</li><li><strong>数据库</strong>: MySQL, Redis, PostgreSQL, MariaDB, MongoDB, Elasticsearch, Prometheus, Microsoft SQL Server</li><li><strong>DevOps 工具</strong>: Gitea, Jenkins, 禅道, Docker Registry, ShowDoc, Nexus Repository</li><li><strong>开发工具</strong>: phpMyAdmin, code-server (浏览器中的 VS Code), IT-Tools, Adminer</li><li><strong>建站系统</strong>: Halo, WordPress, Typecho, Flarum, Wiki.js</li><li><strong>AI / 大模型</strong>: MaxKB (智能体平台), Ollama (本地大模型运行), OpenWebUI, ChatGPT-Next-Web, LobeChat</li><li><strong>运行环境</strong>: PHP (5/7/8), Node.js, <strong>Java</strong>, Python, Go, .NET</li><li><strong>中间件</strong>: MinIO (对象存储), RabbitMQ (消息队列), Nacos (服务发现), Kafka, Apache Tomcat, RocketMQ</li><li><strong>安全工具</strong>: JumpServer (堡垒机), AdGuardHome (DNS 广告拦截), uuWAF (Web 应用防火墙), OpenVPN</li><li><strong>云存储</strong>: AList (多存储文件列表), Nextcloud, Cloudreve</li><li><strong>多媒体</strong>: Jellyfin (媒体服务器), YesPlayMusic (网易云播放器), Navidrome (音乐服务器)</li><li><strong>休闲游戏</strong>: 中文 DOS 游戏, Minecraft 服务器管理 (MCSManager), 幻兽帕鲁服务端</li><li><strong>邮件服务</strong>: Mailserver, Roundcube (Web 邮件客户端)</li><li><strong>BI (商业智能)</strong>: DataEase, Metabase (数据可视化分析工具)</li></ul></li></ul></li></ul><p>其余的一些功能中，能吸引我的还有自动备份功能，未来可能会用到。</p><p>说实话，无法使用nginx反代实现https访问差点把我劝退，1panel的卸载命令都已经敲在了终端中。不过还是更新了一下nginx配置，找到了问题所在，留下来了这个看起来很舒服的面板。希望以后可以发挥更大的作用。</p><h3 class=heading id=哪吒监控v1>哪吒监控V1
<a class=anchor href=#%e5%93%aa%e5%90%92%e7%9b%91%e6%8e%a7v1>#</a></h3><h4 class=heading id=安装前准备>安装前准备
<a class=anchor href=#%e5%ae%89%e8%a3%85%e5%89%8d%e5%87%86%e5%a4%87>#</a></h4><h5 class=heading id=域名>域名
<a class=anchor href=#%e5%9f%9f%e5%90%8d>#</a></h5><p>一个托管在「Cloudflare」的域名。</p><ol><li><p>解析到一个至少1c512MB的服务器上作为面板端（后端、监控端）。</p></li><li><p>开启「websocket」和「gRPC」<figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/20250720201537824.png></div></figure></p></li></ol><h4 class=heading id=安装哪吒面板端>安装哪吒面板端
<a class=anchor href=#%e5%ae%89%e8%a3%85%e5%93%aa%e5%90%92%e9%9d%a2%e6%9d%bf%e7%ab%af>#</a></h4><p>官方手册：<a href=https://nezha.wiki/guide/dashboard.html>安装 Dashboard | 哪吒服务器监控</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L https://raw.githubusercontent.com/nezhahq/scripts/refs/heads/main/install.sh -o nezha.sh &amp;&amp; chmod +x nezha.sh &amp;&amp; sudo ./nezha.sh
</span></span></code></pre></div><p>安装流程：仅需要特别注意nezha-agent地址填入<code>解析域名:443</code><figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/20250720201932192.png></div></figure></p><h4 class=heading id=配置nginx反向代理>配置nginx反向代理
<a class=anchor href=#%e9%85%8d%e7%bd%aenginx%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86>#</a></h4><p>一个推荐的nginx配置</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#888;font-style:italic># ===================================================================
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 哪吒监控 - 后端服务连接池配置
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 定义一个名为 &#34;dashboard&#34; 的后端服务池，用于连接复用，提高性能。
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ===================================================================
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>upstream</span> <span style=color:#666;font-style:italic>dashboard</span> {
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>server</span> 127.0.0.1:8008;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>keepalive</span> 512;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ===================================================================
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># HTTP (80) 到 HTTPS (443) 的永久重定向
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 这是最佳安全实践，确保所有用户都通过加密连接访问。
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ===================================================================
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>server</span> {
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>listen</span> 80;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>listen</span> <span style=color:#666;font-style:italic>[::]:80</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># &lt;--- 修改这里: 将 dashboard.example.com 替换为你的真实域名
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>server_name</span> <span style=color:#666;font-style:italic>dashboard.example.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># 将所有到来的 HTTP 请求通过 301 永久重定向到对应的 HTTPS 地址
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>return</span> 301 <span style=color:#666;font-style:italic>https://</span><span style=color:#666;font-weight:700;font-style:italic>$host$request_uri</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ===================================================================
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># HTTPS (443) 主服务配置
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 所有加密流量的入口，处理 Web、WebSocket 和 gRPC 请求。
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic># ===================================================================
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;text-decoration:underline>server</span> {
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>listen</span> 443 <span style=color:#666;font-style:italic>ssl</span> <span style=color:#666;font-style:italic>http2</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>listen</span> <span style=color:#666;font-style:italic>[::]:443</span> <span style=color:#666;font-style:italic>ssl</span> <span style=color:#666;font-style:italic>http2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># &lt;--- 修改这里: 将 dashboard.example.com 替换为你的真实域名
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>server_name</span> <span style=color:#666;font-style:italic>dashboard.example.com</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># --- SSL 证书配置 ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic># &lt;--- 修改这里: 替换为你的 SSL 证书和私钥的实际路径
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>ssl_certificate</span>          <span style=color:#666;font-style:italic>/etc/letsencrypt/live/dashboard.example.com/fullchain.pem</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_certificate_key</span>      <span style=color:#666;font-style:italic>/etc/letsencrypt/live/dashboard.example.com/key.pem</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># --- SSL 性能与安全优化 (通常无需修改) ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>ssl_stapling</span> <span style=color:#666;font-weight:700;font-style:italic>on</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_session_timeout</span> <span style=color:#666;font-style:italic>1d</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_session_cache</span> <span style=color:#666;font-style:italic>shared:SSL:10m</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>ssl_protocols</span> <span style=color:#666;font-style:italic>TLSv1.2</span> <span style=color:#666;font-style:italic>TLSv1.3</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># 允许 Header 中包含下划线，兼容某些特殊情况
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>underscores_in_headers</span> <span style=color:#666;font-weight:700;font-style:italic>on</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># --- 获取真实访客 IP (Cloudflare CDN 专用配置) ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic># 因为你使用了 Cloudflare，所以保留这两行配置。
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic># 它告诉 Nginx 要信任所有 IP 发来的请求头，并从 CF-Connecting-IP 头中获取真实 IP。
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=color:#888;font-style:italic># 更安全的做法是仅信任来自 Cloudflare 官方 IP 段的请求，但当前配置对于绝大多数场景是足够且方便的。
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>set_real_ip_from</span> 0.0.0.0<span style=color:#666;font-style:italic>/0</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700;text-decoration:underline>real_ip_header</span> <span style=color:#666;font-style:italic>CF-Connecting-IP</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># --- gRPC 请求处理 (Agent 核心数据上报) ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>location</span> <span style=color:#666;font-style:italic>^~</span> <span style=color:#666;font-style:italic>/proto.NezhaService/</span> {
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>grpc_pass</span> <span style=color:#666;font-style:italic>grpc://dashboard</span>; <span style=color:#888;font-style:italic># 将 gRPC 请求转发给后端服务池
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 将真实访客 IP 传递给后端 (使用 Cloudflare 提供的 Header)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>grpc_set_header</span> <span style=color:#666;font-style:italic>nz-realip</span> <span style=color:#666;font-weight:700;font-style:italic>$http_CF_Connecting_IP</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 其他 gRPC 相关优化 (通常无需修改)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>grpc_set_header</span> <span style=color:#666;font-style:italic>Host</span> <span style=color:#666;font-weight:700;font-style:italic>$host</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>grpc_read_timeout</span> <span style=color:#666;font-style:italic>600s</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>grpc_send_timeout</span> <span style=color:#666;font-style:italic>600s</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>grpc_socket_keepalive</span> <span style=color:#666;font-weight:700;font-style:italic>on</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>client_max_body_size</span> 10m;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>grpc_buffer_size</span> 4m;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># --- WebSocket 请求处理 (网页终端、文件管理等实时功能) ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>location</span> ~<span style=color:#666;font-style:italic>*</span> <span style=color:#666;font-style:italic>^/api/v1/ws/(server|terminal|file)(.*)</span>$ {
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_pass</span> <span style=color:#666;font-style:italic>http://127.0.0.1:8008</span>; <span style=color:#888;font-style:italic># 直接转发给后端的 8008 端口
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># --- WebSocket 代理关键配置 ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_http_version</span> 1<span style=color:#666;font-style:italic>.1</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Upgrade</span> <span style=color:#666;font-weight:700;font-style:italic>$http_upgrade</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Connection</span> <span style=color:#666;font-style:italic>&#34;upgrade&#34;</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 将真实访客 IP 传递给后端 (使用 Cloudflare 提供的 Header)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>nz-realip</span> <span style=color:#666;font-weight:700;font-style:italic>$http_CF_Connecting_IP</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 其他 Header 和超时配置 (通常无需修改)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Host</span> <span style=color:#666;font-weight:700;font-style:italic>$host</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Origin</span> <span style=color:#666;font-style:italic>https://</span><span style=color:#666;font-weight:700;font-style:italic>$host</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_read_timeout</span> <span style=color:#666;font-style:italic>3600s</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_send_timeout</span> <span style=color:#666;font-style:italic>3600s</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#888;font-style:italic># --- Web 页面请求处理 (兜底规则) ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>    <span style=font-weight:700;text-decoration:underline>location</span> <span style=color:#666;font-style:italic>/</span> {
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_pass</span> <span style=color:#666;font-style:italic>http://127.0.0.1:8008</span>; <span style=color:#888;font-style:italic># 转发给后端的 8008 端口
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 将真实访客 IP 传递给后端 (使用 Cloudflare 提供的 Header)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>nz-realip</span> <span style=color:#666;font-weight:700;font-style:italic>$http_CF_Connecting_IP</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#888;font-style:italic># 其他 Header 和超时配置 (通常无需修改)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>        <span style=font-weight:700;text-decoration:underline>proxy_set_header</span> <span style=color:#666;font-style:italic>Host</span> <span style=color:#666;font-weight:700;font-style:italic>$host</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_read_timeout</span> <span style=color:#666;font-style:italic>3600s</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_send_timeout</span> <span style=color:#666;font-style:italic>3600s</span>;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_buffer_size</span> 128k;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_buffers</span> 4 256k;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_busy_buffers_size</span> 256k;
</span></span><span style=display:flex><span>        <span style=font-weight:700;text-decoration:underline>proxy_max_temp_file_size</span> 0;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 class=heading id=哪吒面板设置>哪吒面板设置
<a class=anchor href=#%e5%93%aa%e5%90%92%e9%9d%a2%e6%9d%bf%e8%ae%be%e7%bd%ae>#</a></h4><p>到了这一步，此时就可以通过域名访问面板了，并且并没有暴露多余的端口。</p><ul><li>首次登录用户与密码均为<code>admin</code>,第一步先改个默认密码再说。</li><li>因为面板和 agent 都开启了 CF CDN，我们需要在面板系统设置里面的真实 IP 请求头填写<code>CF-Connecting-IP</code>，后台的登录 IP 以及其它地方才能正常显示真实 IP。<figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/20250720202751842.png></div></figure></li></ul><h5 class=heading id=面板开启oauth2>面板开启OAuth2
<a class=anchor href=#%e9%9d%a2%e6%9d%bf%e5%bc%80%e5%90%afoauth2>#</a></h5><p>官方说明：<a href=https://nezha.wiki/guide/q14.html#%E8%AE%BE%E7%BD%AE-oauth-2-0-%E7%BB%91%E5%AE%9A>设置 OAuth 2.0 绑定 | 哪吒服务器监控</a></p><p>我选择使用「github」</p><ol><li>打开 <a href=https://github.com/settings/developers>GitHub开发者设置</a>，依次选择 “OAuth Apps” - “New OAuth App”。</li><li>填写以下需要的字段：</li></ol><ul><li><code>Application name</code>：应用名</li><li><code>Homepage URL</code>：面板访问地址，例如 <code>https://nezha.example.com</code></li><li><code>Authorization callback URL</code> 面板的 Callback 地址，这里只检测前缀，所以可以填写 <code>https://nezha.example.com/api/v1/oauth2/callback</code>。<figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/20250720203459271.png></div></figure></li></ul><ol start=3><li>在新页面中记录 Client ID 和 Client secrets，完成面板 OAuth 2.0 配置：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>oauth2:
</span></span><span style=display:flex><span>  GitHub:
</span></span><span style=display:flex><span>    client_id: <span style=color:#666;font-style:italic>&#34;a-unique-id&#34;</span> <span style=color:#888;font-style:italic># 替换你的 Client ID</span>
</span></span><span style=display:flex><span>    client_secret: <span style=color:#666;font-style:italic>&#34;a-unique-secret&#34;</span> <span style=color:#888;font-style:italic># 替换你的 Client secrets</span>
</span></span><span style=display:flex><span>    endpoint:
</span></span><span style=display:flex><span>      auth_url: <span style=color:#666;font-style:italic>&#34;https://github.com/login/oauth/authorize&#34;</span>
</span></span><span style=display:flex><span>      token_url: <span style=color:#666;font-style:italic>&#34;https://github.com/login/oauth/access_token&#34;</span>
</span></span><span style=display:flex><span>    user_info_url: <span style=color:#666;font-style:italic>&#34;https://api.github.com/user&#34;</span>
</span></span><span style=display:flex><span>    user_id_path: <span style=color:#666;font-style:italic>&#34;id&#34;</span>
</span></span></code></pre></div><ol start=4><li>将以上配置添加到<code>/opt/nezha/dashboard/data/config.yaml</code>面板（Dashboard） 配置</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim /opt/nezha/dashboard/data/config.yaml
</span></span></code></pre></div><ol start=5><li>重启面板使新配置生效</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./nezha.sh 
</span></span></code></pre></div><ol start=6><li>打开个人信息设置绑定github，并关闭密码登录<figure><div class=img-container><img loading=lazy alt src=https://webp.050612.xyz/2025/07/20250720204140554.png></div></figure></li></ol><h4 class=heading id=安装探针agent端服务端>安装探针（agent端、服务端）
<a class=anchor href=#%e5%ae%89%e8%a3%85%e6%8e%a2%e9%92%88agent%e7%ab%af%e6%9c%8d%e5%8a%a1%e7%ab%af>#</a></h4><p>官方教程：<a href=https://nezha.wiki/guide/agent.html>安装 Agent | 哪吒服务器监控</a></p><ol><li>在 <code>服务器</code> 页面中，点击 <code>安装命令</code> 并选择对应操作系统，安装命令将自动复制到你的剪贴板。</li><li>在被控端服务器中运行安装命令，等待安装完成后返回到 <code>服务器</code> 页面查看是否上线。</li></ol><h5 class=heading id=关闭-探针远程控制功能>关闭 探针远程控制功能
<a class=anchor href=#%e5%85%b3%e9%97%ad-%e6%8e%a2%e9%92%88%e8%bf%9c%e7%a8%8b%e6%8e%a7%e5%88%b6%e5%8a%9f%e8%83%bd>#</a></h5><ul><li>打开<code>/opt/nezha/agent/config.yml</code>，把 <code>disable_command_execute</code>改成true</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo vim  /opt/nezha/agent/config.yml
</span></span></code></pre></div><h2 class=heading id=关闭-ipv6--开启bbr>关闭 ipv6 & 开启bbr
<a class=anchor href=#%e5%85%b3%e9%97%ad-ipv6--%e5%bc%80%e5%90%afbbr>#</a></h2><p>我的网络环境为校园网，对ipv6的支持并不好；</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;net.core.default_qdisc=fq&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;net.ipv4.tcp_congestion_control=bbr&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span>sysctl -p
</span></span><span style=display:flex><span>lsmod | grep bbr <span style=color:#888;font-style:italic># 查看是否成功开启BBR</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#888;font-style:italic># 1. 将配置添加到 /etc/sysctl.conf (使用 tee -a 确保安全追加)</span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;net.ipv6.conf.all.disable_ipv6 = 1&#34;</span> | sudo tee -a /etc/sysctl.conf
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;net.ipv6.conf.default.disable_ipv6 = 1&#34;</span> | sudo tee -a /etc/sysctl.conf
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic>echo</span> <span style=color:#666;font-style:italic>&#34;net.ipv6.conf.lo.disable_ipv6 = 1&#34;</span> | sudo tee -a /etc/sysctl.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 2. 使配置立即生效 (并加载所有 /etc/sysctl.conf 中的配置)</span>
</span></span><span style=display:flex><span>sudo sysctl -p
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># 3. (可选) 重启系统以确保所有服务都以新配置启动</span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic># sudo reboot</span>
</span></span></code></pre></div></div></article><div class=single-comments><script src=https://giscus.app/client.js data-repo=eaiu/eaiu.github.io data-repo-id=R_kgDOPMv-Yw data-category data-category-id=DIC_kwDOPMv-Y84CtAeO data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></div><div class=single-pagination><hr><div class=flexnowrap><div class=single-pagination-prev><div class=single-pagination-container-prev><div class=single-pagination-text>←</div><div class=single-pagination-text><a href=/post/%E8%AE%BA%E5%9C%A8%E7%BD%91%E5%90%A7%E7%99%BB%E5%BD%95-steam-%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF/>论在网吧登录 Steam 的正确姿势</a></div></div></div><div class=single-pagination-next></div></div><hr></div><div class=back-to-top><a href=#top>back to top</a></div></div></main></div><footer><p>All content licensed under <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC BY-SA 4.0</a> unless otherwise stated. Copyright © 2025 ghung<br>Powered by <a href=https://gohugo.io/>Hugo</a> and <a href=https://github.com/tomfran/typo>tomfran/typo</a></p></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script></body><script src=/js/theme-switch.js></script><script defer src=/js/copy-code.js></script></html>